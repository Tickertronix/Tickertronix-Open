{% extends "base.html" %}

{% block title %}Credentials - Alpaca Price Hub{% endblock %}

{% block content %}
<h1 style="margin-bottom: 20px;">API Credentials</h1>

{% if api_key %}
<div class="alert alert-success">
    ✅ Credentials are configured (Key: {{ api_key }})
</div>
{% endif %}

<div class="card">
    <h2>Alpaca API Credentials</h2>
    <p style="margin-bottom: 20px; color: #6c757d;">
        Enter your Alpaca API credentials. You can get these from
        <a href="https://alpaca.markets" target="_blank">alpaca.markets</a> (free tier).
    </p>

    <div id="message"></div>

    <form id="credentialsForm">
        <label for="api_key">API Key ID</label>
        <input type="text" id="api_key" name="api_key" placeholder="PKxxxxxxxxxxxxxxxxxx" required>

        <label for="api_secret">API Secret Key</label>
        <input type="password" id="api_secret" name="api_secret" placeholder="Enter your secret key" required>

        <button type="submit" class="btn btn-success">Save & Verify Credentials</button>
    </form>
</div>

<div class="card">
    <h2>Twelve Data API (Forex Only)</h2>
    <p style="margin-bottom: 20px; color: #6c757d;">
        Optional: Add your Twelve Data API key to enable forex pricing (hourly polling, 1 credit per symbol).
    </p>

    <div id="message-td"></div>

    <form id="twelveForm">
        <label for="twelve_api_key">Twelve Data API Key</label>
        <input type="text" id="twelve_api_key" name="twelve_api_key" placeholder="Enter Twelve Data API key" value="{{ twelve_key or '' }}">

        <button type="submit" class="btn btn-secondary">Save Twelve Data Key</button>
    </form>

    {% if twelve_key %}
    <div class="alert alert-info" style="margin-top: 12px;">
        Twelve Data key is set (forex only, hourly).
    </div>
    {% endif %}
</div>

<div class="card">
    <h2>ℹ️ Information</h2>
    <ul style="line-height: 1.8; padding-left: 20px;">
        <li>Credentials are stored locally in your database</li>
        <li>Free tier is sufficient for this application</li>
        <li>Credentials are verified before saving</li>
        <li>You can update credentials anytime</li>
    </ul>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('credentialsForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const messageDiv = document.getElementById('message');
    messageDiv.innerHTML = '<div class="alert alert-info">Verifying credentials...</div>';

    const formData = new FormData(this);

    try {
        const response = await fetch('/credentials', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            messageDiv.innerHTML = '<div class="alert alert-success">✅ ' + data.message + '</div>';
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        } else {
            messageDiv.innerHTML = '<div class="alert alert-error">❌ ' + data.message + '</div>';
        }
    } catch (error) {
        messageDiv.innerHTML = '<div class="alert alert-error">Error: ' + error.message + '</div>';
    }
});

document.getElementById('twelveForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const messageDiv = document.getElementById('message-td');
    messageDiv.innerHTML = '<div class="alert alert-info">Saving Twelve Data key...</div>';

    const formData = new FormData();
    formData.append('action', 'save_twelve_key');
    formData.append('twelve_api_key', document.getElementById('twelve_api_key').value.trim());

    try {
        const response = await fetch('/credentials', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            messageDiv.innerHTML = '<div class="alert alert-success">✅ ' + data.message + '</div>';
        } else {
            messageDiv.innerHTML = '<div class="alert alert-error">❌ ' + data.message + '</div>';
        }
    } catch (error) {
        messageDiv.innerHTML = '<div class="alert alert-error">Error: ' + error.message + '</div>';
    }
});
</script>
{% endblock %}
